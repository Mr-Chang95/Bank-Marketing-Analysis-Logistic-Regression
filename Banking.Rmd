---
title: "bank"
author: "Daniel Chang"
date: "2023-04-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Data and Packages

```{r bank}
library(tidyverse)
library(GGally)
library(skimr)
library(reshape2)
library(caret)
library(olsrr)
library(car)
library(glmnet)
library(pROC)
library(ResourceSelection)
library(MASS)

bank = read.csv("bank-full.csv", stringsAsFactors = T)
head(bank)
```

```{r}
summary(bank)
```

There are a total of 45211 rows and 17 columns. 
```{r}
# Look at structure
str(bank)
# Skim the dataset
skim(bank)
```
### Check for missing values 

No null data in our dataset. 

```{r}
colSums(is.na(bank))
sum(is.na(bank))
```

## Objective 1
### Exploratory Data Analysis(EDA)

Looking at the subscription count, we can see that we have heavily imbalanced dataset.There are almost 40k Nos while there is about about 5k Yes's.

There are several plots that are noteworthy. One is the housing barplot. Even though, we see that the number of count for those with no housing is lower, the subscription count is higher. 

```{r EDA, message = F}
# yes or no subscruption count
ggplot(bank, aes(x = y)) +
  geom_bar() 

# Job Count
ggplot(bank, aes(x = job, fill = y)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Education Count
ggplot(bank, aes(x = education, fill = y)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Age Distribution
ggplot(bank, aes(x = age, fill = y)) +
  geom_histogram(bins = 50)

# Duration Distribution
ggplot(bank, aes(x = duration, fill = y)) +
  geom_histogram(bins = 50)

# Balance Distribution
ggplot(bank, aes(x = balance, fill = y)) +
  geom_histogram(bins = 20)

# Housing Count
ggplot(bank, aes(x = housing, fill = y)) +
  geom_bar()

# Loan 
ggplot(data = bank, aes(x = loan , fill = y)) + 
  geom_bar(stat = 'count', position = 'dodge') + 
  xlab("Loan")+ylab("Response")

# Marital Status 
ggplot(data = bank, aes(x = marital, fill = y)) + 
  geom_bar(stat = 'count', position = 'dodge') + 
  xlab("Marital")+ylab("Response")

# Default
ggplot(data = bank, aes(x = default ,  fill = y)) + 
  geom_bar(stat = 'count', position = 'dodge') + 
  xlab("Default")+ylab("Response")

# Default
ggplot(data = bank, aes(x = poutcome ,  fill = y)) + 
  geom_bar(stat = 'count', position = 'dodge') + 
  xlab("Poutcome")+ylab("Response")

# Previous 
ggplot(data = bank, aes(x = previous, fill = y)) +
  geom_histogram() +
  labs(title = "Distribution of Previous Campaign", 
       x = "Previous Campaign", y = "Count")
```

### Correlation Matrix

After creating a dummy column to make our y column numeric, we can see that there is hardly any correlation between our response variable and the other variables. The strongest relationship is y_num and duration at 0.395. 

```{r Corr Matrix, message = FALSE}
# make new numeric column for "y" column
bank$y_num = num(ifelse(bank$y == "yes",1,0))

## Correlation map
num_cols = unlist(lapply(bank, is.numeric))
data_num = bank[ , num_cols] 
corr_mat = round(cor(data_num),2)
 
# reduce the size of correlation matrix
melted_corr_mat = melt(corr_mat)
# head(melted_corr_mat)
 
# plotting the correlation heatmap
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2,
                                   fill=value)) +
geom_tile() +
geom_text(aes(Var2, Var1, label = value),
          color = "white", size = 4) +
  ggtitle("Heatmap of Correalation For Numeric Variables")

# ggpairs
ggpairs(data_num)
```

### LOESS 
```{r}
# Age (check)
ggplot(bank,aes(x=age,y=y_num))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

# Balance
ggplot(bank,aes(x=balance,y=y_num))+geom_point()+
  geom_smooth(method="loess",size=1,span=0.1, se = FALSE)

# Duration (maybe add poly to it)
ggplot(bank,aes(x=duration,y=y_num))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

# Pdays (check)
ggplot(bank,aes(x=pdays,y=y_num))+geom_point()+
  geom_smooth(method="loess",size=1,span=1, se = FALSE)

# campaign 
ggplot(bank,aes(x=campaign,y=y_num))+geom_point()+
  geom_smooth(method="loess",size=1,span=1, se = FALSE)

# day
ggplot(bank,aes(x=day,y=y_num))+geom_point()+
  geom_smooth(method="loess",size=1,span=1, se = FALSE)
```

### Base Model 

```{r}
bank = bank[,-c(18)] # remove y_num from dataset

set.seed(124)
trainIndex = createDataPartition(bank$y, p= .7, list = F) 
training = bank[trainIndex,]
test = bank[-trainIndex,]

model1 = glm(factor(y)~., data = training, family = "binomial")
summary(model1)
vif(model1)

anova(model1, test = "Chisq")
```

```{r}
model1.coef= coef(model1) # normal coefficient output
model1.coef

model1.OR = exp(coef(model1)) # exp coefficient
model1.OR

# confidence intervals
model1.ci = exp(confint(model1, level = .95)) # confidence interval @ .05 significance
model1.ci
```


### Adjusted Base Model 
```{r}
training1 = training[,-c(1,5,14,15)]
adj.model1 = glm(factor(y)~., data = training1, family = "binomial")
summary(adj.model1)
vif(adj.model1)
```


### Penalized Regression/LASSO
```{r}
fitControl=trainControl(method="repeatedcv",number=5,repeats=1) 

set.seed(124)

lambda=seq(0,.05,.001)
fit.glmnet = train(factor(y)~.,
                 data = training,
                 method = "glmnet",
                 trControl = fitControl,
                 tuneGrid = expand.grid(data.frame(alpha = 1, lambda = lambda)))
fit.glmnet

plot(fit.glmnet)
opt.pen= fit.glmnet$finalModel$lambdaOpt
coef(fit.glmnet$finalModel, opt.pen)
```

```{r}
training2 = training[,-c(1,5,14)]
pen.model1 = glm(factor(y)~., data = training2, family = "binomial")
summary(pen.model1)
vif(pen.model1)
```


```{r}
# Generate an ROC curve to help us determine the best threshold
fit.glmnet_predictions = predict(fit.glmnet, test, type = "prob")$yes
fit.glmnet_roc = roc(response = test$y, predictor = fit.glmnet_predictions, levels = c("no", "yes"))
auc(fit.glmnet_roc)
plot(fit.glmnet_roc, print.thres = "best", col = "black")

# Predict
threshold = 0.107
fit.glmnet_predictions_categorical = factor(ifelse(predict(fit.glmnet, test, type = "prob")$yes >= threshold, "yes", "no"), levels = c("no", "yes"))
confusionMatrix(data = fit.glmnet_predictions_categorical, reference = factor(test$y, levels = c("no", "yes")))
```


### Stepwise Feature Selection
```{r}
set.seed(124)
fit.step  = glm(factor(y) ~., data = training, family = binomial) %>%
  stepAIC(trace = FALSE)
summary(fit.step)

coef(fit.step)
vif(fit.step)

# Generate an ROC curve to help us determine the best threshold
fit.step_predictions = predict(fit.step, test, type = "response")
fit.step_roc = roc(response = test$y, predictor = fit.step_predictions, levels = c("no", "yes"))
auc(fit.step_roc)
plot(fit.step_roc, print.thres = "best", col = "black")

# Predict
threshold = 0.093
fit.step_predictions_categorical = factor(ifelse(predict(fit.step, test, "response") >= threshold, "yes", "no"), levels = c("no", "yes"))
confusionMatrix(data = fit.step_predictions_categorical, reference = factor(test$y, levels = c("no", "yes")))
```

### Manual Stepwise
```{r}
logit_step = glm(factor(y) ~ housing + contact + month + duration + poutcome, data = training, family = "binomial")
summary(logit_step)
vif(logit_step)

# Generate an ROC curve to help us determine the best threshold
logit_step_predictions = predict(logit_step, test, type = "response")
logit_step_roc = roc(response = test$y, predictor = logit_step_predictions, levels = c("no", "yes"))
auc(logit_step_roc)
plot(logit_step_roc, print.thres = "best", col = "black")

# Predict
threshold = 0.101
logit_step_predictions_categorical = factor(ifelse(predict(logit_step, test, "response") >= threshold, "yes", "no"), levels = c("no", "yes"))
confusionMatrix(data = logit_step_predictions_categorical, reference = factor(test$y, levels = c("no", "yes")))
```

### AIC Comparison 
```{r}
AIC(model1)
AIC(adj.model1)
AIC(pen.model1)
AIC(fit.step)
AIC(logit_step)

anova(logit_step, pen.model1, test = "Chisq")
```


```{r}
anova(pen.model1, fit.step)
hoslem.test(fit.step$y,fitted(fit.step),g=10)
hoslem.test(fit.step$y,fitted(fit.step),g=10)
```

## Objective 2

```{r}
## Age
ggplot(bank,aes(x=age,y=y_num, color = marital))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

ggplot(bank,aes(x=age,y=y_num, color = education))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE) # no difference 

ggplot(bank,aes(x=age,y=y_num, color = housing))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

ggplot(bank,aes(x=age,y=y_num, color = loan))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)


## Balance
ggplot(bank,aes(x=balance,y=y_num, color = marital))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

ggplot(bank,aes(x=balance,y=y_num, color = housing))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE) # no difference

ggplot(bank,aes(x=balance,y=y_num, color = education))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

ggplot(bank,aes(x=balance,y=y_num, color = loan))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

## Duration
ggplot(bank,aes(x=duration,y=y_num, color = marital))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

ggplot(bank,aes(x=duration,y=y_num, color = housing))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

ggplot(bank,aes(x=duration,y=y_num, color = education))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

ggplot(bank,aes(x=duration,y=y_num, color = loan))+geom_point()+
  geom_smooth(method="loess",size=1,span=.75, se = FALSE)

## Pdays
ggplot(bank,aes(x=pdays,y=y_num, color = marital))+geom_point()+
  geom_smooth(method="loess",size=1,span=1, se = FALSE)

ggplot(bank,aes(x=pdays,y=y_num, color = housing))+geom_point()+
  geom_smooth(method="loess",size=1,span=1, se = FALSE)

ggplot(bank,aes(x=pdays,y=y_num, color = education))+geom_point()+
  geom_smooth(method="loess",size=1,span=1, se = FALSE)

ggplot(bank,aes(x=pdays,y=y_num, color = loan))+geom_point()+
  geom_smooth(method="loess",size=1,span=1, se = FALSE)
```

```{r}

```

